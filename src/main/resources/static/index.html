<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SMS - Situational Awareness & Audit Tool</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-wrapper { position: relative; width: 100%; height: 260px; }
        .checklist-item { border-left-width: 4px; border-left-color: #e2e8f0; transition: all 0.2s; }
        .checklist-item.checked { background-color: #f0fdf4; border-left-color: #22c55e; }
        .checklist-item.negative { background-color: #fef2f2; border-left-color: #ef4444; }

        /* REGRAS DE IMPRESS√ÉO (PDF) */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; }
            .container { max-width: 100%; padding: 0; }
            /* For√ßa a impress√£o dos gr√°ficos e cores de fundo */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            /* Ajuste de layout para evitar quebras ruins */
            main, aside { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="container mx-auto p-4 lg:p-8 max-w-[1600px]">
    <header class="mb-8 border-b border-slate-200 pb-6 flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter uppercase">SMS Dashboard</h1>
            <p class="text-sky-600 font-bold text-xs tracking-widest uppercase mt-1">Safety Management System | M.Sc. ITA</p>
        </div>
        <div class="text-right hidden sm:block no-print">
            <p class="text-xs text-slate-400 font-mono">API STATUS: <span id="api-status" class="text-yellow-500 font-bold">CONNECTING...</span></p>
        </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">

        <main class="xl:col-span-7 flex flex-col gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 print:shadow-none print:border-none">
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-slate-100 text-slate-600 p-2 rounded-lg mr-3 text-xl no-print">üìã</span>
                    1. Check-list de Prontid√£o (20 Itens)
                </h2>
                <div id="accordion-container" class="space-y-4"></div>
            </div>

            <div class="flex flex-wrap gap-4 no-print">
                <button id="save-db-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-xl shadow-lg transition-transform hover:scale-[1.01] flex justify-center items-center gap-2 min-w-[200px]">
                    <span>üíæ</span> SALVAR OPERA√á√ÉO
                </button>

                <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition-colors flex items-center gap-2">
                    <span>üñ®Ô∏è</span> PDF / IMPRIMIR
                </button>

                <button onclick="location.reload()" class="bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-4 px-6 rounded-xl transition-colors">
                    ‚Ü∫ LIMPAR
                </button>
            </div>
        </main>

        <aside class="xl:col-span-5 flex flex-col gap-6">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 print:border-slate-300">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center mb-2">Consci√™ncia Situacional</h3>
                    <div class="chart-wrapper">
                        <canvas id="saRadarChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 print:border-slate-300">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center mb-2">Distribui√ß√£o de Risco</h3>
                    <div class="chart-wrapper">
                        <canvas id="riskDistChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <div class="bg-white p-4 rounded-xl border-l-4 border-slate-400 shadow-sm print:border-slate-400">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Total</p>
                    <h4 id="total-missions" class="text-2xl font-black text-slate-700">0</h4>
                </div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm print:border-red-500">
                    <p class="text-[10px] font-black text-red-500 uppercase">Alto</p>
                    <h4 id="high-risk-count" class="text-2xl font-black text-red-600">0</h4>
                </div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-yellow-500 shadow-sm print:border-yellow-500">
                    <p class="text-[10px] font-black text-yellow-500 uppercase">M√©dio</p>
                    <h4 id="mid-risk-count" class="text-2xl font-black text-yellow-600">0</h4>
                </div>
                <div class="bg-white p-4 rounded-xl border-l-4 border-green-500 shadow-sm print:border-green-500">
                    <p class="text-[10px] font-black text-green-500 uppercase">Baixo</p>
                    <h4 id="low-risk-count" class="text-2xl font-black text-green-600">0</h4>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex-1">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-slate-800">Hist√≥rico Recente</h2>
                    <button id="btn-export" class="text-[10px] font-black bg-slate-800 text-white px-3 py-2 rounded hover:bg-black uppercase no-print">
                        Exportar CSV
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-400 uppercase text-[10px] font-black border-b border-slate-100">
                        <tr>
                            <th class="pb-3 pl-2">Data</th>
                            <th class="pb-3">Risco</th>
                            <th class="pb-3 text-right">Scores (H|W|A|M)</th>
                        </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8081/api/v1/safety';

    // DADOS MESTRES DO CHECKLIST (4 Categorias x 5 Itens = 20 Itens Totais)
    const checklistData = [
        {
            id: 'health', title: 'SA√öDE (Fatores Humanos)',
            items: [
                {id:'h1', text:'Repouso adequado (8h)?'}, {id:'h2', text:'Hidrata√ß√£o/Alimenta√ß√£o?'},
                {id:'h3', text:'N√≠vel de estresse/Fadiga?'}, {id:'h4', text:'Medicamentos ou √Ålcool?'},
                {id:'h5', text:'Equipamento (EPI) completo?'}
            ]
        },
        {
            id: 'climate', title: 'METEOROLOGIA (Ambiente)',
            items: [
                {id:'c1', text:'Vento dentro do envelope?'}, {id:'c2', text:'Visibilidade/Teto?'},
                {id:'c3', text:'Temperatura/Umidade?'}, {id:'c4', text:'Previs√£o de mudan√ßa?'},
                {id:'c5', text:'Turbul√™ncia esperada?'}
            ]
        },
        {
            id: 'envelope', title: 'AERONAVE (M√°quina)',
            items: [
                {id:'e1', text:'Combust√≠vel suficiente?'}, {id:'e2', text:'Peso e Balanceamento?'},
                {id:'e3', text:'Sistemas de pulveriza√ß√£o?'}, {id:'e4', text:'Manuten√ß√£o em dia?'},
                {id:'e5', text:'Performance para pista?'}
            ]
        },
        {
            id: 'risk', title: 'MISS√ÉO (Opera√ß√£o)',
            items: [
                {id:'r1', text:'Obst√°culos mapeados?'}, {id:'r2', text:'Comunica√ß√£o solo-ar?'},
                {id:'r3', text:'Press√£o de tempo?'}, {id:'r4', text:'Plano de conting√™ncia?'},
                {id:'r5', text:'√Åreas sens√≠veis pr√≥ximas?'}
            ]
        }
    ];

    let state = { itemStates: {}, comments: {} };
    let saRadarChart = null;
    let riskDistChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        renderChecklist();
        initializeCharts();
        carregarDashboard();
        checkApiConnection();
    });

    // --- RENDERIZA√á√ÉO DA UI ---
    function renderChecklist() {
        const container = document.getElementById('accordion-container');
        checklistData.forEach(cat => {
            const group = document.createElement('div');
            group.className = 'border-b border-slate-100 last:border-0 pb-4 mb-4';

            group.innerHTML = `<h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">${cat.title}</h3>`;

            const list = document.createElement('div');
            list.className = 'space-y-3';

            cat.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.id = `cont-${item.id}`;
                itemDiv.className = 'checklist-item p-3 rounded-r-lg bg-slate-50 hover:bg-slate-100 cursor-pointer print:bg-white print:border';

                // Layout do Item: Texto + Status + Input de Coment√°rio
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2" onclick="toggleItem('${item.id}')">
                        <span class="text-sm font-medium text-slate-700">${item.text}</span>
                        <span id="icon-${item.id}" class="text-lg grayscale opacity-40">‚ö™</span>
                    </div>
                    <input type="text"
                        class="w-full text-xs bg-white border border-slate-200 rounded p-2 focus:ring-2 focus:ring-sky-500 outline-none transition-all placeholder:text-slate-300 print:border-none print:p-0"
                        placeholder="Observa√ß√µes / Mitiga√ß√£o..."
                        oninput="updateComment('${item.id}', this.value)"
                        onclick="event.stopPropagation()"
                    />
                `;
                list.appendChild(itemDiv);
            });
            group.appendChild(list);
            container.appendChild(group);
        });
    }

    // --- L√ìGICA DE ESTADO ---
    function toggleItem(id) {
        const current = state.itemStates[id] || 'unmarked';
        const next = current === 'unmarked' ? 'checked' : (current === 'checked' ? 'negative' : 'unmarked');
        state.itemStates[id] = next;

        updateItemUI(id, next);
        updateRadar();
    }

    function updateItemUI(id, status) {
        const cont = document.getElementById(`cont-${id}`);
        const icon = document.getElementById(`icon-${id}`);

        cont.classList.remove('checked', 'negative');
        icon.classList.add('grayscale', 'opacity-40');

        if (status === 'checked') {
            cont.classList.add('checked');
            icon.innerText = '‚úÖ';
            icon.classList.remove('grayscale', 'opacity-40');
        } else if (status === 'negative') {
            cont.classList.add('negative');
            icon.innerText = '‚õî';
            icon.classList.remove('grayscale', 'opacity-40');
        } else {
            icon.innerText = '‚ö™';
        }
    }

    function updateComment(id, value) {
        state.comments[id] = value;
    }

    // --- GR√ÅFICOS (CHART.JS) ---
    function initializeCharts() {
        const ctxRadar = document.getElementById('saRadarChart').getContext('2d');
        saRadarChart = new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: ['Sa√∫de', 'Clima', 'Aeronave', 'Miss√£o'],
                datasets: [{
                    label: 'Prontid√£o',
                    data: [0, 0, 0, 0],
                    backgroundColor: 'rgba(14, 165, 233, 0.2)',
                    borderColor: '#0ea5e9',
                    borderWidth: 2,
                    pointBackgroundColor: '#0ea5e9'
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: { r: { min: 0, max: 100, ticks: { display: false }, pointLabels: { font: { size: 10, weight: 'bold' } } } },
                plugins: { legend: { display: false } }
            }
        });

        const ctxRisk = document.getElementById('riskDistChart').getContext('2d');
        riskDistChart = new Chart(ctxRisk, {
            type: 'doughnut',
            data: {
                labels: ['Baixo', 'M√©dio', 'Alto'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 10 } } } }
            }
        });
    }

    function updateRadar() {
        const scores = checklistData.map(cat => {
            const okItems = cat.items.filter(it => state.itemStates[it.id] === 'checked').length;
            return Math.round((okItems / cat.items.length) * 100);
        });

        saRadarChart.data.datasets[0].data = scores;

        const avg = scores.reduce((a,b)=>a+b,0)/4;
        let color = '#0ea5e9';
        if(avg < 40) color = '#ef4444';
        else if(avg < 75) color = '#f59e0b';

        saRadarChart.data.datasets[0].borderColor = color;
        saRadarChart.data.datasets[0].pointBackgroundColor = color;
        saRadarChart.data.datasets[0].backgroundColor = color + '33';
        saRadarChart.update();
    }

    // --- COMUNICA√á√ÉO COM API ---
    document.getElementById('save-db-button').addEventListener('click', async () => {
        const mitigationText = Object.entries(state.comments)
            .filter(([_, txt]) => txt && txt.trim().length > 0)
            .map(([id, txt]) => `[${id.toUpperCase()}]: ${txt}`)
            .join(' | ');

        const payload = {
            pilotName: "Cmte. Matheus Guerra",
            healthScore: checklistData[0].items.filter(it => state.itemStates[it.id] === 'checked').length,
            weatherScore: checklistData[1].items.filter(it => state.itemStates[it.id] === 'checked').length,
            aircraftScore: checklistData[2].items.filter(it => state.itemStates[it.id] === 'checked').length,
            missionScore: checklistData[3].items.filter(it => state.itemStates[it.id] === 'checked').length,
            mitigationPlan: mitigationText
        };

        try {
            const res = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const data = await res.json();
                alert(`‚úÖ OPERA√á√ÉO SALVA!\nN√≠vel de Risco: ${data.riskLevel}`);
                carregarDashboard();
                location.reload();
            } else {
                const err = await res.json();
                alert(`‚õî BLOQUEIO SMS:\n${err.message}`);
            }
        } catch (e) {
            alert("‚ùå Erro de conex√£o com o servidor.");
        }
    });

    async function carregarDashboard() {
        try {
            const res = await fetch(`${API_BASE_URL}/history`);
            const data = await res.json();

            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';

            let counts = { HIGH: 0, MEDIUM: 0, LOW: 0, NO_GO: 0 };

            data.reverse().slice(0, 50).forEach(row => {
                if(counts[row.riskLevel] !== undefined) counts[row.riskLevel]++;

                const date = new Date(row.dateTime).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                const colorClass = row.riskLevel === 'HIGH' || row.riskLevel === 'NO_GO' ? 'text-red-600 font-black' : (row.riskLevel === 'MEDIUM' ? 'text-yellow-600 font-bold' : 'text-green-600 font-bold');

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                        <td class="py-3 pl-2 text-xs font-mono text-slate-500">${date}</td>
                        <td class="py-3 text-xs ${colorClass}">${row.riskLevel}</td>
                        <td class="py-3 text-right text-xs font-mono text-slate-400 tracking-tighter">${row.healthScore}|${row.weatherScore}|${row.aircraftScore}|${row.missionScore}</td>
                    </tr>
                `;
            });

            document.getElementById('total-missions').innerText = data.length;
            document.getElementById('high-risk-count').innerText = counts.HIGH + counts.NO_GO;
            document.getElementById('mid-risk-count').innerText = counts.MEDIUM;
            document.getElementById('low-risk-count').innerText = counts.LOW;

            riskDistChart.data.datasets[0].data = [counts.LOW, counts.MEDIUM, counts.HIGH + counts.NO_GO];
            riskDistChart.update();

        } catch (e) {
            console.error("Falha ao carregar hist√≥rico", e);
        }
    }

    async function checkApiConnection() {
        const statusEl = document.getElementById('api-status');
        try {
            await fetch(`${API_BASE_URL}/history`, { method: 'HEAD' });
            statusEl.innerText = "ONLINE";
            statusEl.className = "text-green-500 font-bold";
        } catch {
            statusEl.innerText = "OFFLINE";
            statusEl.className = "text-red-500 font-bold";
        }
    }

    document.getElementById('btn-export').addEventListener('click', () => {
        window.location.href = `${API_BASE_URL}/export`;
    });
</script>
</body>
</html>