<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SMS - Situational Awareness Tool | Cmte. Matheus Guerra</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin: 0 auto; height: 350px; }
        .checklist-item-container { border-left-width: 4px; border-left-color: #cbd5e1; transition: all 0.2s ease; }
        .checklist-item-container.checked { background-color: #f0fdf4; border-left-color: #22c55e; }
        .checklist-item-container.negative { background-color: #fff1f2; border-left-color: #ef4444; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
    <header class="no-print text-center mb-12 border-b pb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-900 uppercase tracking-tight">SMS - Situational Awareness Tool</h1>
        <p class="mt-2 text-lg text-sky-600 font-medium italic">Matheus Guerra | Aviation Safety M.Sc. (ITA)</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <section id="checklist">
            <h2 class="text-xl font-bold mb-6 text-slate-700 flex items-center">
                <span class="mr-2">ðŸ“‹</span> 1. Check-list Interativo (SA NÃ­veis 1, 2 e 3)
            </h2>
            <div id="accordion-container" class="space-y-4"></div>

            <div class="no-print mt-8 flex flex-wrap gap-3">
                <button id="save-db-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform hover:scale-105">
                    FINALIZAR E SALVAR NA API
                </button>
                <button id="reset-button" onclick="location.reload()" class="bg-slate-300 hover:bg-slate-400 text-slate-700 font-bold py-3 px-6 rounded-lg transition-all">
                    REDEFINIR
                </button>
            </div>
        </section>

        <section class="space-y-8">
            <div id="summary" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-center mb-4 text-slate-700">2. Radar de ProntidÃ£o Operacional</h2>
                <div class="chart-container">
                    <canvas id="saRadarChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-slate-400 text-center">
                    <p class="text-[10px] text-slate-500 uppercase font-black">Total de MissÃµes</p>
                    <h3 id="total-missions" class="text-2xl font-black">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500 text-center">
                    <p class="text-[10px] text-red-500 uppercase font-black">Alertas HIGH</p>
                    <h3 id="high-risk-count" class="text-2xl font-black text-red-600">0</h3>
                </div>
            </div>
        </section>

        <section id="history" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-xl font-bold text-slate-700 mb-6">3. HistÃ³rico de Auditoria</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-[10px] font-black">
                    <tr>
                        <th class="p-4">Data/Hora</th>
                        <th class="p-4">Risco</th>
                        <th class="p-4">Scores (H|W|A|M)</th>
                    </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8081/api/v1/safety';

    // Checklist Restaurado com os 20 itens originais
    const checklistData = [
        {
            id: 'health',
            title: 'SaÃºde do Piloto',
            items: [
                {id:'h1', text:'Desjejum adequado?'},
                {id:'h2', text:'Ãgua potÃ¡vel a bordo?'},
                {id:'h3', text:'Sinais de fadiga?'},
                {id:'h4', text:'Ãlcool/Drogas (24-48h)?'},
                {id:'h5', text:'Uniforme e EPIs?'}
            ]
        },
        {
            id: 'climate',
            title: 'Meteorologia',
            items: [
                {id:'c1', text:'Temperatura adequada?'},
                {id:'c2', text:'Umidade relativa?'},
                {id:'c3', text:'Vento dentro dos limites?'},
                {id:'c4', text:'PressÃ£o atmosfÃ©rica?'},
                {id:'c5', text:'MudanÃ§as sÃºbitas?'}
            ]
        },
        {
            id: 'envelope',
            title: 'Envelope (Aeronave)',
            items: [
                {id:'e1', text:'Altura de voo?'},
                {id:'e2', text:'Bicos limpos?'},
                {id:'e3', text:'PressÃ£o do sistema?'},
                {id:'e4', text:'Volume de calda?'},
                {id:'e5', text:'ComposiÃ§Ã£o otimizada?'}
            ]
        },
        {
            id: 'risk',
            title: 'Gerenciamento de Risco',
            items: [
                {id:'r1', text:'Toxicidade conhecida?'},
                {id:'r2', text:'Equipe treinada?'},
                {id:'r3', text:'Ãreas sensÃ­veis?'},
                {id:'r4', text:'Zonas de Buffer?'},
                {id:'r5', text:'ComunicaÃ§Ã£o solo?'}
            ]
        }
    ];

    let state = { itemStates: {} };
    let saRadarChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        renderChecklist();
        initializeChart();
        carregarHistorico();
    });

    function renderChecklist() {
        const container = document.getElementById('accordion-container');
        checklistData.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm';
            div.innerHTML = `<div class="bg-slate-50 px-4 py-2 text-xs font-black uppercase text-slate-500 border-b">${cat.title}</div>`;
            const list = document.createElement('div');
            cat.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.id = `cont-${item.id}`;
                itemDiv.className = 'checklist-item-container p-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 text-sm';
                itemDiv.innerHTML = `<span>${item.text}</span><span id="icon-${item.id}" class="opacity-30">â—¯</span>`;
                itemDiv.onclick = () => toggleItem(item.id);
                list.appendChild(itemDiv);
            });
            div.appendChild(list);
            container.appendChild(div);
        });
    }

    function toggleItem(id) {
        const current = state.itemStates[id] || 'unmarked';
        state.itemStates[id] = current === 'unmarked' ? 'checked' : (current === 'checked' ? 'negative' : 'unmarked');
        const cont = document.getElementById(`cont-${id}`);
        const icon = document.getElementById(`icon-${id}`);
        cont.classList.remove('checked', 'negative');
        if(state.itemStates[id] === 'checked') { cont.classList.add('checked'); icon.innerText = 'âœ…'; icon.classList.remove('opacity-30'); }
        else if(state.itemStates[id] === 'negative') { cont.classList.add('negative'); icon.innerText = 'âŒ'; icon.classList.remove('opacity-30'); }
        else { icon.innerText = 'â—¯'; icon.classList.add('opacity-30'); }
        updateChart();
    }

    function initializeChart() {
        const ctx = document.getElementById('saRadarChart').getContext('2d');
        saRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['SaÃºde', 'Clima', 'Aeronave', 'MissÃ£o'],
                datasets: [{
                    label: 'ProntidÃ£o %',
                    data: [0, 0, 0, 0],
                    backgroundColor: 'rgba(14, 165, 233, 0.2)',
                    borderColor: '#0ea5e9',
                    borderWidth: 3,
                    pointBackgroundColor: '#0ea5e9'
                }]
            },
            options: {
                scales: { r: { min: 0, max: 100, ticks: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });
    }

    function updateChart() {
        const scores = checklistData.map(cat => {
            const total = cat.items.length;
            const ok = cat.items.filter(it => state.itemStates[it.id] === 'checked').length;
            return Math.round((ok / total) * 100);
        });

        const avgScore = scores.reduce((a,b) => a+b, 0) / 4;
        let color = '#0ea5e9';
        if(avgScore < 40) color = '#ef4444';
        else if(avgScore < 75) color = '#f59e0b';
        else color = '#22c55e';

        saRadarChart.data.datasets[0].data = scores;
        saRadarChart.data.datasets[0].borderColor = color;
        saRadarChart.data.datasets[0].backgroundColor = color + '33';
        saRadarChart.update();
    }

    document.getElementById('save-db-button').addEventListener('click', async () => {
        const payload = {
            pilotName: "Cmte. Matheus Guerra",
            healthScore: checklistData[0].items.filter(it => state.itemStates[it.id] === 'checked').length,
            weatherScore: checklistData[1].items.filter(it => state.itemStates[it.id] === 'checked').length,
            aircraftScore: checklistData[2].items.filter(it => state.itemStates[it.id] === 'checked').length,
            missionScore: checklistData[3].items.filter(it => state.itemStates[it.id] === 'checked').length
        };

        try {
            const res = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                const result = await res.json();
                alert(`Voo Autorizado! Risco: ${result.riskLevel}`);
                carregarHistorico();
            } else {
                const error = await res.json();
                alert(`BLOQUEIO SMS: ${error.message}`);
            }
        } catch (e) { alert("Erro de conexÃ£o com a API."); }
    });

    async function carregarHistorico() {
        try {
            const res = await fetch(`${API_BASE_URL}/history`);
            const dados = await res.json();
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            dados.reverse().slice(0, 5).forEach(v => {
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors border-b">
                        <td class="p-4 text-[10px] font-mono text-slate-400">${new Date(v.dateTime).toLocaleString()}</td>
                        <td class="p-4 font-black text-[10px] ${v.riskLevel==='HIGH'?'text-red-500':'text-green-500'}">${v.riskLevel}</td>
                        <td class="p-4 text-slate-500 font-mono">${v.healthScore}|${v.weatherScore}|${v.aircraftScore}|${v.missionScore}</td>
                    </tr>`;
            });
            document.getElementById('total-missions').innerText = dados.length;
            document.getElementById('high-risk-count').innerText = dados.filter(d => d.riskLevel === 'HIGH').length;
        } catch (e) { console.error("API Offline"); }
    }
</script>
</body>
</html>